---
import Layout from '../../layouts/Layout.astro';

const base = import.meta.env.BASE_URL;
---

<Layout
  title="WMS Preview · Labs"
  description="Preview WMS layers on a dark basemap without any backend."
>
  <head>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
    />
  </head>

  <header class="lab-hero">
    <p class="lab-kicker">LABS / WMS</p>
    <h1 class="lab-title">WMS Preview</h1>
    <p class="lab-subtitle">
      Load a WMS GetCapabilities document, choose a layer, and preview it on a dark basemap.
    </p>

    <div class="lab-actions">
      <a class="btn secondary" href={`${base}labs/`}>Back to Labs</a>
    </div>
  </header>

  <section class="lab-shell" aria-label="WMS preview workspace">
    <div class="lab-panel">
      <div class="lab-panel__head">
        <div>
          <p class="panel-kicker mono">WMS INPUT</p>
          <h2 class="panel-title">Load GetCapabilities</h2>
        </div>
      </div>

      <label class="field-label" for="wmsUrl">WMS URL</label>
      <div class="field-row">
        <input
          id="wmsUrl"
          class="lab-input"
          type="url"
          placeholder="https://example.com/geoserver/wms?service=WMS&request=GetCapabilities"
        />
        <button class="btn cta" id="loadWmsBtn" type="button">Fetch</button>
      </div>
      <p class="field-hint">
        If CORS blocks the request, open the URL in a new tab and ensure it allows cross-origin access.
      </p>

      <div class="lab-status" aria-live="polite">
        <div>
          <span class="status-label">Layers</span>
          <span id="statusLayers">0</span>
        </div>
        <div>
          <span class="status-label">Selected</span>
          <span id="statusSelected">-</span>
        </div>
        <div class="status-pill" id="statusMessage">Idle</div>
      </div>

      <div class="lab-alert" id="alert" role="alert" hidden></div>
      <div class="lab-warning" id="warning" role="status" hidden></div>

      <div class="layer-list" id="layerList" hidden>
        <p class="list-title">Available layers</p>
        <div id="layerItems" class="list-items" role="radiogroup" aria-label="WMS layers"></div>
      </div>
    </div>

    <div class="map-panel" aria-label="Map preview">
      <div id="map" class="map"></div>
      <aside class="info-panel" aria-live="polite">
        <h3 class="info-title">Layer Info</h3>
        <pre id="layerInfo" class="info-content">Select a layer to render it on the map.</pre>
      </aside>
    </div>
  </section>

  <script is:inline>
  const start = async () => {
    // Load OpenLayers (JS + CSS)
    const load = (src) =>
      new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = res;
        s.onerror = rej;
        document.head.appendChild(s);
      });

    const loadCss = (href) => {
      const l = document.createElement('link');
      l.rel = 'stylesheet';
      l.href = href;
      document.head.appendChild(l);
    };

    loadCss('https://cdn.jsdelivr.net/npm/ol@9.2.4/ol.css');
    await load('https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js');

    const {
      Map,
      View,
      layer: { Tile },
      source: { OSM, TileWMS },
      proj: { fromLonLat },
    } = ol;

    const map = new Map({
      target: 'map',
      layers: [
        new Tile({
          source: new OSM({
            url: 'https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attributions: '© OpenStreetMap · © CARTO',
          }),
        }),
      ],
      view: new View({
        center: fromLonLat([15, 62]),
        zoom: 4,
      }),
    });

    const wmsUrlInput = document.getElementById('wmsUrl');
    const loadBtn = document.getElementById('loadWmsBtn');
    const layerItems = document.getElementById('layerItems');
    const layerList = document.getElementById('layerList');
    const statusLayers = document.getElementById('statusLayers');
    const statusSelected = document.getElementById('statusSelected');
    const statusMessage = document.getElementById('statusMessage');
    const alertBox = document.getElementById('alert');
    const warningBox = document.getElementById('warning');
    const layerInfo = document.getElementById('layerInfo');

    let wmsLayer = null;
    let layers = [];
    let effectiveWmsUrl = '';

    const setStatus = (t) => (statusMessage.textContent = t);
    
    const showAlert = (t) => {
      alertBox.hidden = false;
      alertBox.textContent = t;
      warningBox.hidden = true;
    };

    const showWarning = (t) => {
      warningBox.hidden = false;
      warningBox.textContent = t;
      alertBox.hidden = true;
    };

    const hideMessages = () => {
      alertBox.hidden = true;
      warningBox.hidden = true;
    };

    const clear = () => {
      layerItems.innerHTML = '';
      layerList.hidden = true;
      statusLayers.textContent = '0';
      statusSelected.textContent = '-';
      layerInfo.textContent = 'Select a layer to render it on the map.';
      if (wmsLayer) map.removeLayer(wmsLayer);
      wmsLayer = null;
      hideMessages();
    };

    const parseCapabilities = (xml) => {
      const doc = new DOMParser().parseFromString(xml, 'text/xml');
      
      // Check for ServiceException
      const exception = doc.querySelector('ServiceException, ServiceExceptionReport');
      if (exception) {
        return { error: 'ServiceException', message: exception.textContent?.trim() || 'Service error' };
      }

      const layerNodes = [...doc.querySelectorAll('Layer > Name')]
        .map((n) => ({
          name: n.textContent,
          title: n.parentElement.querySelector('Title')?.textContent || n.textContent,
        }))
        .filter((l) => l.name);

      return { layers: layerNodes };
    };

    const fetchCapabilities = async () => {
      clear();
      setStatus('Fetching');

      let baseUrl;
      let originalUrl = wmsUrlInput.value.trim();
      
      try {
        baseUrl = new URL(originalUrl);
      } catch {
        showAlert('Invalid URL. Please enter a valid WMS service URL.');
        setStatus('Error');
        return;
      }

      // Auto-fix HTTP → HTTPS
      let wasAutoFixed = false;
      if (baseUrl.protocol === 'http:') {
        setStatus('Auto-fixing URL');
        wasAutoFixed = true;
        baseUrl.protocol = 'https:';
        
        // Test if HTTPS works
        const testUrl = new URL(baseUrl.toString());
        testUrl.searchParams.set('service', 'WMS');
        testUrl.searchParams.set('request', 'GetCapabilities');
        
        try {
          const testRes = await fetch(testUrl.toString(), { method: 'HEAD' });
          if (!testRes.ok) throw new Error('HTTPS not available');
        } catch (httpsError) {
          // HTTPS doesn't work - show clear error
          showAlert(
            '⚠️ This WMS service only supports insecure HTTP connections. ' +
            'Because this site runs on HTTPS, browsers block HTTP map services for security reasons (Mixed Content policy). ' +
            'Unfortunately, this layer cannot be displayed here. Try contacting the service provider to request HTTPS support.'
          );
          setStatus('Blocked');
          return;
        }
        
        // HTTPS works! Update the input field
        wmsUrlInput.value = baseUrl.toString();
        effectiveWmsUrl = baseUrl.toString();
      } else {
        effectiveWmsUrl = baseUrl.toString();
      }

      baseUrl.searchParams.set('service', 'WMS');
      baseUrl.searchParams.set('request', 'GetCapabilities');

      try {
        const res = await fetch(baseUrl.toString());
        const text = await res.text();
        
        const result = parseCapabilities(text);
        
        if (result.error) {
          showAlert(
            `The WMS service returned an error: ${result.message}. ` +
            'This could mean the service is unavailable or misconfigured.'
          );
          setStatus('Error');
          return;
        }

        layers = result.layers;

        if (!layers.length) {
          showAlert('No named layers found in the GetCapabilities document. The service may not support layer queries.');
          setStatus('Idle');
          return;
        }

        statusLayers.textContent = layers.length.toString();
        layerList.hidden = false;

        layerItems.innerHTML = layers
          .map(
            (l, i) => `
          <label class="layer-item">
            <input type="radio" name="layer" data-i="${i}">
            <span>${l.title}</span>
          </label>`
          )
          .join('');

        setStatus('Ready');
        
        if (wasAutoFixed) {
          showWarning('✓ HTTP URL was automatically upgraded to HTTPS and is working correctly.');
        }
      } catch (e) {
        showAlert(
          'Unable to load GetCapabilities. This could be due to CORS restrictions (cross-origin policy), ' +
          'network issues, or the service being unavailable. ' +
          'Try opening the URL directly in your browser to verify access.'
        );
        setStatus('Error');
      }
    };

    layerItems.addEventListener('change', (e) => {
      const input = e.target;
      if (!(input instanceof HTMLInputElement)) return;

      const layer = layers[Number(input.dataset.i)];
      if (!layer) return;

      if (wmsLayer) map.removeLayer(wmsLayer);

      // Create WMS layer with error handling
      const tileSource = new TileWMS({
        url: effectiveWmsUrl,
        params: {
          LAYERS: layer.name,
          FORMAT: 'image/png',
          TRANSPARENT: true,
        },
        serverType: 'geoserver',
      });

      // Listen for tile load errors
      tileSource.on('tileloaderror', (event) => {
        showWarning(
          '⚠️ Some tiles failed to load. This could be due to: unsupported coordinate system (CRS), ' +
          'service limits, or network issues. Try zooming or panning to a different area.'
        );
      });

      wmsLayer = new Tile({
        source: tileSource,
      });

      map.addLayer(wmsLayer);
      statusSelected.textContent = layer.title;
      layerInfo.textContent = `${layer.title}\n(${layer.name})`;
      hideMessages(); // Clear previous warnings when switching layers
    });

    loadBtn.addEventListener('click', fetchCapabilities);
    setStatus('Idle');
  };

  document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', start)
    : start();
</script>
</Layout>

<style>
.lab-hero{
  text-align: center;
  padding: var(--spacing-xl) 0 var(--spacing-lg);
}
.lab-kicker{
  font-family: var(--font-mono);
  font-size: 0.78rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: rgba(88,166,255,0.8);
  margin-bottom: 8px;
}
.lab-title{
  margin: 0 0 8px;
  font-family: var(--font-display);
  letter-spacing: 0.03em;
}
.lab-subtitle{
  margin: 0 auto;
  color: rgba(230,237,243,0.72);
  max-width: 60ch;
}
.lab-actions{
  margin-top: var(--spacing-md);
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.lab-shell{
  display: grid;
  grid-template-columns: minmax(280px, 420px) 1fr;
  gap: var(--spacing-lg);
  align-items: start;
}
@media (max-width: 980px){
  .lab-shell{ grid-template-columns: 1fr; }
}

.lab-panel{
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(13,17,23,0.55);
  padding: var(--spacing-md);
  box-shadow: 0 20px 55px rgba(0,0,0,0.28);
}
.lab-panel__head{
  display: flex;
  gap: 12px;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
.panel-kicker{
  font-size: 0.7rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(88,166,255,0.72);
  margin: 0 0 6px;
}
.panel-title{
  margin: 0;
  font-size: 1.2rem;
}

.field-label{
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
}
.lab-input,
.lab-file{
  width: 100%;
  background: rgba(13,17,23,0.4);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 10px 12px;
  color: rgba(230,237,243,0.9);
}
.field-row{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.field-row .lab-input{ flex: 1 1 220px; }
.field-actions{ margin-top: 10px; }
.field-hint{
  margin-top: 8px;
  color: rgba(230,237,243,0.55);
  font-size: 0.85rem;
}

.lab-status{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 8px;
  margin-top: var(--spacing-md);
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(88,166,255,0.16);
  background: rgba(13,17,23,0.35);
  font-size: 0.85rem;
}
.status-label{
  display: block;
  color: rgba(88,166,255,0.72);
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}
.status-pill{
  align-self: center;
  justify-self: end;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(13,17,23,0.3);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.7rem;
}

.lab-alert,
.lab-warning{
  margin-top: 12px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255, 90, 90, 0.3);
  background: rgba(120, 20, 20, 0.2);
  color: rgba(255, 200, 200, 0.9);
  font-size: 0.9rem;
}
.lab-warning{
  border-color: rgba(246, 217, 110, 0.4);
  background: rgba(60, 50, 18, 0.35);
  color: rgba(246, 217, 110, 0.92);
}

.layer-list{
  margin-top: 14px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(88,166,255,0.2);
  background: rgba(13,17,23,0.4);
}
.list-title{
  margin: 0 0 10px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(88,166,255,0.8);
}
.list-items{
  display: grid;
  gap: 8px;
  max-height: 320px;
  overflow: auto;
}
.layer-item{
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 0.9rem;
  color: rgba(230,237,243,0.85);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(13,17,23,0.25);
}
.layer-item input{ accent-color: rgba(88,166,255,0.95); }

.map-panel{
  position: relative;
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(13,17,23,0.5);
  min-height: 520px;
}
.map{
  width: 100%;
  height: 520px;
}
.info-panel{
  position: absolute;
  right: 16px;
  bottom: 16px;
  max-width: 320px;
  background: rgba(13,17,23,0.82);
  border: 1px solid rgba(88,166,255,0.2);
  border-radius: 14px;
  padding: 12px;
  color: rgba(230,237,243,0.85);
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
}
.info-title{
  margin: 0 0 6px;
  font-size: 0.85rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(88,166,255,0.8);
}
.info-content{
  margin: 0;
  max-height: 240px;
  overflow: auto;
  font-size: 0.8rem;
  white-space: pre-wrap;
}
</style>
